<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:o="http://omnifaces.org/ui" xmlns:of="http://omnifaces.org/functions" template="/uii/template/template_blank.html" xmlns:x="http://myfaces.apache.org/tomahawk" xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites">

    <ui:define name="content">

		 <style>

			body {
				background:black;
			}
			
			#mainImage {
				border: none;
			    widht: 100%;
				height:98vh;
			}
            
            #mainImage #ajaxloader_image {
                position: absolute;
                left:50%;
                top:50%;
                margin-left: -34px;
                margin-top: -21px;
            }
            
            #mainImage #ajaxloader_image img{
                border: none;
            }
            
			
			html, body {
				overflow-x: hidden;
			}

            #zoomSliderLabel {
                position: absolute;
                top: 10px;
                left: 10px;
                width: 100px;
                background: transparent;
                border: none;
            }
            
            #zoomSliderLabel input{
                border: none;
                background-color: transparent;
                width:60px;
                text-align: right;
            }
            
            #zoomSliderLabel input:focus{
                background-color: white;
                color: #666;
            }
            
            #image-control-wrapper {
              position: absolute;
                top: 10px;
                left: 10px;
            }
            
            #image-control-wrapper ul {
                padding-left: 0;
            }
            
            #image-control-wrapper li {
                display: inline-block;
            }
            
            #image-control-wrapper li label{
                width: 50px;
            }
            
            #image-control-wrapper #reset-position {
                margin-left: 86px;
            }


		</style>

        <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/reactiveX/rx.lite.min.js"></script>
<script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/q-promises/q.min.js"></script>

<script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/openseadragon/openseadragon.min.js"></script>
    <script
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/openseadragon/openseadragon-viewerinputhook.js"></script>
    <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/imageView/imageView.image.js"></script>
    <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/imageView/imageView.tileSourceResolver.js"></script>
    <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/imageView/imageView.measures.js"></script>
    <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/imageView/imageView.controls.js"></script>
    <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/imageView/imageView.zoomSlider.js"></script>
    <!-- 3D-Models -->
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/three.min.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/OBJLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/MTLLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/PLYLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/STLLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/FBXLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/TDSLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/DRACOLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/loaders/GLTFLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/controls/OrbitControls.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/three/dependencies/inflate.min.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/OBJMTLLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/PLYMeshLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/STLMeshLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/TDSMeshLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/FBXMeshLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/GLTFDRACOLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/X3DLoader.js"></script>
    <script type="text/javascript"
        src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/viewObject/WorldGenerator.js"></script>
    <script src="#{HelperForm.applicationWebsiteUrl}/uii/template/js/x3dom/x3dom.js"></script>

        <h:form id="qaform" style="margin-top:-15px;">

			<!-- big image -->
			<div class="row margin-top-most margin-bottom-most" style="height:95vh;">
			    <h:panelGroup styleClass="div-image" layout="block">
			        <div id="mainImage" class="margin-bottom-regular" rendered="#{AktuelleSchritteForm.myPlugin.image != null}">
                        <div id="ajaxloader_image">
                            <img src="template/img/goobi/ajaxloader1.gif" />
                        </div>
                    </div>
			        <script type="text/javascript">
                                    	var configViewer = {
                            			    global: {
                            			    	divId: 'mainImage',
                            			        useTiles: true,
                            			        footerHeight: 0,
                            			        adaptContainerHeight: false,
                            			        zoomSlider: "#zoomSlider",
                            			        zoomSliderHandle: "#zoomSlider .zoom-slider-handle",
                            			        zoomSliderLabel: "#zoomSliderLabel input",
                                                webApiToken: '#{AktuelleSchritteForm.myPlugin.imageWebApiToken}',

                            			    },
                            			    image: {
                            			        mimeType: "image/jpeg",
                            			        tileSource : [#{AktuelleSchritteForm.myPlugin.image.imageLevels}],
                             			   		originalImageWidth: "#{AktuelleSchritteForm.myPlugin.image.size.width}",
                             			   		originalImageHeight: "#{AktuelleSchritteForm.myPlugin.image.size.height}",
                            			    }
                            			};									
                            		    
                                    	var worldConfig = {
									 			controls: {
									 			    xAxis: {
									 			        rotateLeft: '#rotate-left-x',
									 			        rotateRight: '#rotate-right-x'
									 			    },
									 			   yAxis: {
									 			        rotateLeft: '#rotate-left-y',
									 			        rotateRight: '#rotate-right-y'
									 			    },
									 			   zAxis: {
									 			        rotateLeft: '#rotate-left-z',
									 			        rotateRight: '#rotate-right-z'
									 			    },
									 			    position: {
									 			    	reset: '#reset-position'   
									 			    },
									 			    zoom: {
									 			        resetZoom: '#reset#zoom'
									 			    }
									 			},
									    		container: {
									    			id: "mainImage"
									    		},
										 };
                                    	
									 	var mediaType = "#{AktuelleSchritteForm.myPlugin.image.type}";
									 	console.log("Media type = ", mediaType);
									 	if(mediaType == "image") {
									 		
										    var viewImage = new ImageView.Image( configViewer );
										    viewImage.load()
										    .then(function(image) {
										        image.onFirstTileLoaded()
										        .then(function() {										            
										        	$('#ajaxloader_image').fadeOut(800);
										        })
										        .catch(function() {
										            $('#ajaxloader_image').fadeOut(800);
										        })
										    })
										    .catch(function(error){
										        console.error( 'Error opening image', error );
										        $('#ajaxloader_image').fadeOut(800);
										        $('#' + configViewer.global.divId).html( 'Failed to load image: "' + error + '"' );
										    });
									    
									 	} else if(mediaType == "object") {
									 	   $('#ajaxloader_image').show();
									 		var world = WorldGenerator.create(worldConfig);
									 		world.loadObject({
									 	 		 url: "#{AktuelleSchritteForm.myPlugin.image.objectUrl}",
									 			 position: { x:0, y:0, z:-0 },
									 			 rotation:  { x:0, y:0, z:0 },
									 			 size:  10,
									 			 material: {
									 					color: 0x44bb33
									 				},
									 			focus: true,
									 			onTick: function(object, time) {
									 				if(object) {
// 									 	 				object.rotation.set(0,  Math.PI/180 * time, 0);
									 				}
									 			}
									 		 }).then(function(object) {
									 	       	 $('#ajaxloader_image').fadeOut(2000);
									 		 	world.render();
									 		 }).catch(function(error) {
									 		    $('#ajaxloader_image').fadeOut(2000);
									 			 console.err("failed to load: ", error);
									 		 })
									 		
									 	} else if(mediaType == "x3dom") {
									 	    var objectUrl = "#{AktuelleSchritteForm.myPlugin.image.objectUrl}";
									 	   $('#ajaxloader_image').show();
    									 	    new X3DLoader().load($('#mainImage'), objectUrl, 
									 	            function(){
    									 	       		$('#ajaxloader_image').fadeOut(2000);
    									 	       		console.log("loaded")
									 	            },
									 	           function(){
									 	               console.log("progress");
									 	            },
									 	           function(error){
									 	               $('#ajaxloader_image').fadeOut(2000);
									 	               console.log("error", error);
									 	            })
									 	}
									 	
									 	 function freeJSResources(data) {
										        if(!data || data.status == 'begin') {									            
	    									        if(viewImage) {
	    									            console.log("closing OpenSeadragon viewer");
	    									            viewImage.close();
	    									        }
	    									        if(world) {
	    									            console.log("disposing 3d scene");
	    									            world.dispose();
	    									        }
										        }
										    }
                                    </script>
			    </h:panelGroup>
			</div>
			<!-- // big image -->
				
                <ui:fragment rendered="#{AktuelleSchritteForm.myPlugin.image.type == 'image'}">
                    <div id="zoomSliderLabel" class="font-light">
                            <input></input><span>%</span>
                    </div>
                </ui:fragment>
                <ui:fragment rendered="#{AktuelleSchritteForm.myPlugin.image.type == 'object'}">
                    <div id="image-control-wrapper">
            			<nav id="viewer_controls_nav">

                            <ul style="margin-top:1px;">
            					<li><label>#{msgs.rotation_x_axis}</label></li>
            					<li>
            						<span class="btn font-size-s" id="rotate-left-x" title="#{msg.rotateLeft}">
            							<i class="fa fa-undo"></i>
            						</span>
            					</li>
            					<li>
            						<span class="btn font-size-s" id="rotate-right-x" title="#{msg.rotateRight}">
            							<i class="fa fa-repeat"></i>
            						</span>
            					</li>
            				</ul>
                            <ul style="margin-top:1px;">
                            <li><label>#{msgs.rotation_y_axis}</label></li>
                                <li>
                                    <span class="btn font-size-s" id="rotate-left-y" title="#{msg.rotateLeft}">
                                        <i class="fa fa-undo"></i>
                                    </span>
                                </li>
                                <li>
                                    <span class="btn font-size-s" id="rotate-right-y" title="#{msg.rotateRight}">
                                        <i class="fa fa-repeat"></i>
                                    </span>
                                </li>
                            </ul>
                            <ul style="margin-top:1px;">
                                <li><label>#{msgs.rotation_z_axis}</label></li>
                                <li>
                                    <span class="btn font-size-s" id="rotate-left-z" title="#{msg.rotateLeft}">
                                        <i class="fa fa-undo"></i>
                                    </span>
                                </li>
                                <li>
                                    <span class="btn font-size-s" id="rotate-right-z" title="#{msg.rotateRight}">
                                        <i class="fa fa-repeat"></i>
                                    </span>
                                </li>
                            </ul>
                            <ul style="margin-top:1px;">
                                <li>
                                    <span class="btn font-size-s margin-right-10" id="reset-position" title="#{msg.resetImage}">
                                        <i class="fa fa-refresh"></i>
                                    </span>
                                </li>
                            </ul>
            			</nav>
            			</div>
                </ui:fragment>
                
				<!-- exit fullscreen -->
				<h:commandLink styleClass="btn btn-lightgrey" style="position:absolute;top:10px; right:10px;" 
					action="ImageQAPlugin" title="#{msgs.imageDefaultDisplay}" >
					<i class="fa fa-close"></i>
				</h:commandLink>
				
				<!-- previous image -->
				<h:commandLink id="imageBack" styleClass="btn btn-lightgrey font-size-s" title="#{msgs.lw_previousImage}"
					style="position:absolute;top:50vh; left:10px; height:50px;padding-top:17px;">
					<i class="fa fa-angle-left"></i>
					<f:ajax execute="@form" render="@form" onevent="freeJSResources"/>
					<x:updateActionListener value="#{AktuelleSchritteForm.myPlugin.imageIndex - 1}" property="#{AktuelleSchritteForm.myPlugin.imageIndex}" />
				</h:commandLink>
				
				<!-- next image -->
				<h:commandLink id="imageNext" styleClass="btn btn-lightgrey font-size-s" title="#{msgs.lw_nextImage}"
					style="position:absolute;top:50vh; right:10px; height:50px; padding-top:17px;">
					<i class="fa fa-angle-right"></i>
					<f:ajax execute="@form" render="@form" onevent="freeJSResources"/>
					<x:updateActionListener value="#{AktuelleSchritteForm.myPlugin.imageIndex + 1}" property="#{AktuelleSchritteForm.myPlugin.imageIndex}" />
				</h:commandLink>
				
				<!-- file name -->
				<h:outputText styleClass="font-light" style="position:absolute;bottom:10px; left:10px;" 
					value="#{AktuelleSchritteForm.myPlugin.image.imageName}" />
				
				<!-- image number -->
				<div style="position:absolute;bottom:10px; right:10px;">
	                <x:outputText id="txtImageMoveTo1" styleClass="font-light"
	                    value="#{AktuelleSchritteForm.myPlugin.imageIndex +1} #{msgs.von}  #{AktuelleSchritteForm.myPlugin.sizeOfImageList}"
	                    onclick="document.getElementById(this.id).nextSibling.style.display='inline';
	                    document.getElementById(this.id).style.display='none';  
	                    document.getElementById(this.id).nextSibling.focus(); 
	                    document.getElementById(this.id).nextSibling.select();" /> 
					<!-- jump to page -->
	                <x:inputText value="#{AktuelleSchritteForm.myPlugin.imageMoveTo}" style="display:none;font-size:9px;width:30px"
	                    required="true" id="txtImageMoveTo2"
	                    onblur="document.getElementById(this.id).style.display='none';document.getElementById(this.id).previousSibling.style.display='inline';"
	                    onkeypress="copyValue(this,event);" />
	                <x:commandButton action="#{NavigationForm.Reload}" value="go" style="display:none" />
				</div>
				
				<!-- first and last page -->				
				<div style="position:absolute;top:10px;left:10px;display:none;">
					<h:commandLink styleClass="btn btn-lightgrey font-size-s margin-right-10" title="#{msgs.firstImage}">
						<i class="fa fa-double-angle-left"></i>
						<f:ajax execute="@form" render="@form" />
						<x:updateActionListener value="0" property="#{AktuelleSchritteForm.myPlugin.imageIndex}" />
					</h:commandLink>
					<h:commandLink styleClass="btn btn-lightgrey font-size-s" title="#{msgs.lastImage}">
						<i class="fa fa-double-angle-right"></i>
						<f:ajax execute="@form" render="@form" />
						<x:updateActionListener value="#{AktuelleSchritteForm.myPlugin.sizeOfImageList - 1}" property="#{AktuelleSchritteForm.myPlugin.imageIndex}" />
					</h:commandLink>
				</div>

		</h:form>


        <script type="text/javascript">
		     
        	// Find the right method, call on correct element
	        function launchIntoFullscreen(element) {
	          if(element.requestFullscreen) {
	            element.requestFullscreen();
	          } else if(element.mozRequestFullScreen) {
	            element.mozRequestFullScreen();
	          } else if(element.webkitRequestFullscreen) {
	            element.webkitRequestFullscreen();
	          } else if(element.msRequestFullscreen) {
	            element.msRequestFullscreen();
	          }
	        }
	
	       window.onload = function() {
		    	launchIntoFullscreen(document.documentElement); // the whole page
		    	loadImages();
		    }
		
			jsf.ajax.addOnEvent(function(data) {
			    var ajaxstatus = data.status; // Can be "begin", "complete" and "success"
			      
			      switch (ajaxstatus) {
			          case "success": // This is called when ajax response is successfully processed.
			              loadImages();
			              break;
			      }
				
			});
			
			function copyValue(element, e) {
			    console.log(element.id);
			    if (element.id =='qaform:first:txtMoveTo2') {
			        document.getElementById('qaform:second:txtMoveTo2').value = element.value;
			    } else if (element.id =='qaform:second:txtMoveTo2'){
			        document.getElementById('qaform:first:txtMoveTo2').value = element.value;
			    } else if (element.id =='qaform:first_image:txtImageMoveTo2') {
			        document.getElementById('qaform:second_image:txtImageMoveTo2').value = element.value;
			    } else {
			        document.getElementById('qaform:first_image:txtImageMoveTo2').value = element.value;
			    }
			    
			    var keycode;
				if (window.event)
					keycode = window.event.keyCode;
				else if (e)
					keycode = e.which;
				else
					return true;
				
				if (keycode == 13) {
					document.getElementById(element.id).nextSibling.click();
					return false;
				} else
					return true;
			    
			}
		
			$(document).bind('keyup', '#{LoginForm.myBenutzer.shortcutPrefix}+right', function() {            	
            	var myButton = document.getElementById("qaform:imageNext");
            	if (myButton!=null) {
            		myButton.click();
            	} 
            });
            
            $(document).bind('keyup', '#{LoginForm.myBenutzer.shortcutPrefix}+left', function() {            	
            	var myButton = document.getElementById("qaform:imageBack");
            	if (myButton!=null) {
            		myButton.click();
            	} 
            });
			
		</script>
    </ui:define>

</ui:composition>