<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://xmlns.jcp.org/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:h="http://xmlns.jcp.org/jsf/html" xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:o="http://omnifaces.org/ui" xmlns:of="http://omnifaces.org/functions" template="/uii/template/template.html" xmlns:x="http://myfaces.apache.org/tomahawk" xmlns:intranda="http://xmlns.jcp.org/jsf/composite/composites">

    <ui:param name="myPageTitle" value="#{msgs.plugin}: #{msgs[('plugin_').concat(AktuelleSchritteForm.myPlugin.title)]}" />

    <ui:define name="breadcrumb">
        <intranda:breadcrumb label="#{msgs.startseite}" action="index" navId="a0" />
        <intranda:breadcrumb label="#{msgs.aktuelleSchritte}" action="#{AktuelleSchritteForm.paginator.returnToPreviousPage}" />
       	<intranda:breadcrumb label="#{AktuelleSchritteForm.mySchritt.prozess.titel}" action="#{AktuelleSchritteForm.myPlugin.cancel}" />
        <intranda:breadcrumb label="#{myPageTitle}" noSeparator="#{true}" />
    </ui:define>

    <ui:define name="info">
    </ui:define>

    <ui:define name="content">

        <style>
/* Thumbnails */
.goobi-thumbnail {
    float: left;
    margin: 7px;
    width: #{AktuelleSchritteForm.myPlugin.thumbnailSize +2}px;
    height: #{AktuelleSchritteForm .myPlugin.thumbnailSize+55}px;
}

.goobi-thumbnail .goobi-thumbnail-image {
    float: left;
    width: 100%;
    min-height: 100px;
    overflow: hidden;
    max-height: #{AktuelleSchritteForm.myPlugin.thumbnailSize +2}px;
}

.goobi-thumbnail .goobi-thumbnail-image a {
    display: block;
}

.goobi-thumbnail .goobi-thumbnail-image a img {
    display: block;
    max-width: 100%;
    max-height: 175px;
    margin: 0 auto;
    border: 1px solid lightgrey;
}

.goobi-thumbnail .goobi-thumbnail-caption {
    float: left;
    width: 100%;
    min-height: 20px;
    line-height: 20px;
    text-align: center;
}

.goobi-thumbnail .goobi-thumbnail-controls {
    float: left;
    width: 100%;
    margin-top: 5px;
}

.goobi-thumbnail-controls-left {
    width: 60%;    
}

.goobi-thumbnail-controls-right {
    width: 40%;
}

.goobi-thumbnail-controls-left {
    padding-left: 25px;
}

.goobi-thumbnail-controls-left .thumbnail-control {
    margin-right: 3px;
}

.goobi-thumbnail-controls-right {
    padding-right: 25px;
    text-align: right;
}

.goobi-thumbnail-controls-right .thumbnail-control {
    margin-left: 3px;
}

.thumbnail-control {
    padding: 3px 5px;
}

.thumbnail-control.checkbox {
    position: relative;
    margin: 0 3px 0 0;
}

.thumbnail-control.checkbox label {
    margin: 0;
    padding: 0;
}

.thumbnail-control.checkbox .control-indicator .fa-square-o, .thumbnail-control.checkbox .control-indicator .fa-check-square-o {
    margin-top: 4px;
}

.thumbnail-control.checkbox .control-indicator .fa-square-o {
    padding-right: 2px;
}

.thumbnail-control.checkbox .control-indicator .fa-check-square-o {
    display: none;
}

.thumbnail-control.checkbox input[type="checkbox"] {
    position: absolute;
    margin: 0;
    visibility: hidden;
    z-index: -1;
}

.thumbnail-control.checkbox input:checked ~ .control-indicator .fa-check-square-o {
    display: inline-block;
}

.thumbnail-control.checkbox input:checked ~ .control-indicator .fa-square-o {
    display: none;
}

.thumb-canvas{
	border: 1px solid #ccc;
}

.big-image-caption {
    text-align: center;
}

.div-image img {
    float: right;
    border: solid 1px;
    border-color: lightgrey;
}

.img-active {
    background-color: #368ee0;
    color: white;
}

.image-navigation {
    margin-bottom: 5px;
}

#image-control-wrapper {
    margin-left: 6px;
}

#mainImage {
    widht: 100%;
}

.namePart {
	display: inline-block;
	width: auto;
	min-width: 20px;
	margin-left: 15px;
	margin-bottom: 10px;
}

</style>

	<!-- image navigation -->
<!-- 	<script src="template/js/reactiveX/rx.lite.min.js"></script> -->
<!-- 	<script src="template/js/q-promises/q.min.js"></script> -->
<!-- 	<script src="template/js/openseadragon/openseadragon.min.js"></script> -->
<!-- 	<script -->
<!-- 		src="template/js/openseadragon/openseadragon-viewerinputhook.js"></script> -->
	
        <script type="text/javascript" src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/rx.lite.min.js"></script>
        <script type="text/javascript" src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/q.min.js"></script>
        <script type="text/javascript" src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/openseadragon/openseadragon.min.js"></script>
        <script type="text/javascript" src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/openseadragon/openseadragon-viewerinputhook.js"></script>
		<script type="text/javascript" src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.js"></script>

<!--         <script type="text/javascript" src="#{HelperForm.applicationWebsiteUrl}/uii/plugins/step/#{AktuelleSchritteForm.myPlugin.title}/javascript/viewImage.zoomSlider.js"></script> -->

        <h:form id="qaform">
            <div class="box box-color lightgrey box-bordered">
                <div class="box-title">
                    <h3>
                        <i class="fa fa-puzzle-piece" />
                        <h:outputText id="id9" value="#{msgs.details}" />
                    </h3>
                    <div class="actions">
                        <h:commandLink id="id10" action="#{NavigationForm.Reload}" styleClass="btn btn-mini">
                            <i class="fa fa-refresh" />
                        </h:commandLink>
                    </div>
                </div>

                <div class="box-content">

                    <h:panelGroup layout="block" rendered="#{AktuelleSchritteForm.myPlugin.sizeOfImageList gt 0}" styleClass="col-sm-7">

                        <div class="row">
                            <f:subview id="first">
                                <ui:include src="ImageQAPlugin_include_thumbnavigation.xhtml" />
                            </f:subview>
                        </div>

                        <!-- Thumbnail list -->
                        <div class="row margin-top-most margin-bottom-most">

                            <!--                              <c:forEach var="image" items="#{AktuelleSchritteForm.myPlugin.paginatorList}" varStatus="status"> -->
                            <ui:repeat var="image" value="#{AktuelleSchritteForm.myPlugin.paginatorList}" varStatus="status">
                                <div class="goobi-thumbnail #{AktuelleSchritteForm.myPlugin.image.imageName eq image.imageName?'img-active':'font-light'}">
                                    <div class="goobi-thumbnail-image">

                                        <div class="thumb">
                                            <h:commandLink title="#{image.tooltip}">
                                                <canvas class="thumb-canvas" data-image_small="#{HelperForm.servletPathWithHostAsUrl}#{image.thumbnailUrl}" data-image_large="#{HelperForm.servletPathWithHostAsUrl}#{image.largeThumbnailUrl}" title="#{image.tooltip}" id="thumbnail-#{status.index}"></canvas>
                                                <f:setPropertyActionListener value="#{image.order -1}" target="#{AktuelleSchritteForm.myPlugin.imageIndex}" />
                                                <f:ajax execute="@form" render="@form :bigimage" />

                                            </h:commandLink>
                                        </div>


                                        <!--                                         <h:commandLink title="#{image.tooltip}"> -->
                                        <!--                                             <h:graphicImage value="#{image.thumbnailUrl}" title="#{image.tooltip}" styleClass="#{image.imageName == AktuelleSchritteForm.myPlugin.image.imageName ? 'img-active' : ''}" /> -->
                                        <!--                                             <f:setPropertyActionListener value="#{image.order -1}" target="#{AktuelleSchritteForm.myPlugin.imageIndex}"/> -->
                                        <!--                                         	<f:ajax execute="@form" render="@form :bigimage"/> -->
                                        <!--                                         </h:commandLink> -->
                                    </div>
                                    <div class="goobi-thumbnail-caption">
                                        <h:outputText value="#{image.imageNameShort}"></h:outputText>
                                    </div>

                                    <h:panelGroup styleClass="goobi-thumbnail-controls" rendered="#{NavigationForm.uiStatus.plugin_qa_confirmation == false}">

                                        <div class="goobi-thumbnail-controls-left pull-left">
                                            <!-- select current image -->
                                            <h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.allowSelection}">
                                                <span class="btn thumbnail-control checkbox">
                                                    <label class="control checkbox">
                                                        <h:selectBooleanCheckbox value="#{image.selected}" />
                                                        <span class="control-indicator">
                                                            <i class="fa fa fa-check-square-o"></i>
                                                            <i class="fa fa fa-square-o"></i>
                                                        </span>
                                                    </label>

                                                </span>
                                            </h:panelGroup>
                                            <!--  modal rendern  -->
                                            <h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.allowRenaming}">
                                                <a class="btn thumbnail-control rename" title="#{msgs.plugin_intranda_step_imageQA_rename} #{image.tooltip}" href="#" data-toggle="modal" data-target="#myModal-#{status.index}">
                                                    <i class="fa fa-pencil" />
                                                </a>
                                            </h:panelGroup>
                                            <h:commandLink styleClass="btn thumbnail-control delete" title="#{msgs.plugin_intranda_step_imageQA_delete} #{image.tooltip}" action="#{AktuelleSchritteForm.myPlugin.deleteImage(image)}" rendered="#{AktuelleSchritteForm.myPlugin.allowDeletion}">
                                                <i class="fa fa-trash"></i>
                                            </h:commandLink>
                                        </div>
                                        <div class="goobi-thumbnail-controls-right pull-right">
                                        <h:commandLink styleClass="btn thumbnail-control rotate-left" title="#{msgs.plugin_intranda_step_imageQA_rotateLeft} #{image.tooltip}" action="#{AktuelleSchritteForm.myPlugin.rotateLeft(image)}" rendered="#{AktuelleSchritteForm.myPlugin.allowRotation}">
                                            <i class="fa fa-undo"></i>
                                        </h:commandLink>
                                    	<h:commandLink styleClass="btn thumbnail-control rotate-right" title="#{msgs.plugin_intranda_step_imageQA_rotateRight} #{image.tooltip}" action="#{AktuelleSchritteForm.myPlugin.rotateRight(image)}" rendered="#{AktuelleSchritteForm.myPlugin.allowRotation}">
                                            <i class="fa fa-repeat"></i>
                                        </h:commandLink>
                                        </div>
                                    </h:panelGroup>

                                    <h:panelGroup styleClass="goobi-thumbnail-controls" rendered="#{NavigationForm.uiStatus.plugin_qa_confirmation != false}">
                                        <div class="goobi-thumbnail-controls-left pull-left">
                                            <!-- select current image -->
                                            <h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.allowSelection}">
                                                <span class="btn thumbnail-control checkbox">
                                                    <label class="control checkbox">
                                                        <h:selectBooleanCheckbox value="#{image.selected}" />
                                                        <span class="control-indicator">
                                                            <i class="fa fa fa-check-square-o"></i>
                                                            <i class="fa fa fa-square-o"></i>
                                                        </span>
                                                    </label>

                                                </span>
                                            </h:panelGroup>

                                            <!--  modal rendern  -->
                                            <h:panelGroup rendered="#{AktuelleSchritteForm.myPlugin.allowRenaming}">
                                                <a class="btn thumbnail-control rename" title="#{msgs.plugin_intranda_step_imageQA_rename} #{image.tooltip}" href="#" data-toggle="modal" data-target="#myModal-#{status.index}">
                                                    <i class="fa fa-pencil" />
                                                </a>
                                            </h:panelGroup>
                                            <h:commandLink styleClass="btn thumbnail-control delete" title="#{msgs.plugin_intranda_step_imageQA_delete} #{image.tooltip}" action="#{AktuelleSchritteForm.myPlugin.deleteImage(image)}" rendered="#{AktuelleSchritteForm.myPlugin.allowDeletion}" onclick="if (!confirm('#{msgs.wirklichAusfuehren}')) return false">
                                                <i class="fa fa-trash"></i>
                                            </h:commandLink>
                                        </div>

                                        <div class="goobi-thumbnail-controls-right pull-right">
                                            <h:commandLink styleClass="btn thumbnail-control rotate-left" title="#{msgs.plugin_intranda_step_imageQA_rotateLeft} #{image.tooltip}" action="#{AktuelleSchritteForm.myPlugin.rotateLeft(image)}" rendered="#{AktuelleSchritteForm.myPlugin.allowRotation}" onclick="if (!confirm('#{msgs.wirklichAusfuehren}')) return false">
                                                <i class="fa fa-undo"></i>
                                            </h:commandLink>
                                         	<h:commandLink styleClass="btn thumbnail-control rotate-right" title="#{msgs.plugin_intranda_step_imageQA_rotateRight} #{image.tooltip}" action="#{AktuelleSchritteForm.myPlugin.rotateRight(image)}" rendered="#{AktuelleSchritteForm.myPlugin.allowRotation}" onclick="if (!confirm('#{msgs.wirklichAusfuehren}')) return false">
                                                <i class="fa fa-repeat"></i>
                                            </h:commandLink>
                                        </div>
                                    </h:panelGroup>

                                </div>

                                <div class="modal fade" id="myModal-#{status.index}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <a href="#" class="btn btn-blue pull-right" title="#{msgs.cancel}" data-dismiss="modal">
                                                    <i class="fa fa-times"></i>
                                                </a>
                                                <h4 class="modal-title" id="myModalLabel">
                                                    <h:outputText value="#{msgs.plugin_intranda_step_imageQA_renameTitle}: #{image.imageName}" />
                                                </h4>
                                            </div>
                                            <div class="modal-body">
                                                <h:outputText value="#{msgs.plugin_intranda_step_imageQA_renameDescription}" />

                                                <div class="row" style="margin-top: 15px;">
	                                                    <ui:repeat var="namePart" value="#{image.nameParts}">
		                                                    	<x:inputText styleClass="form-control namePart" value="#{namePart.value}" />
	                                                    </ui:repeat>
                                                </div>

                                            </div>
                                            <div class="modal-footer">

                                                <a href="#" class="btn pull-left font-size-s" title="#{msgs.abbrechen}" data-dismiss="modal">
                                                    <h:outputText value="#{msgs.abbrechen}" />
                                                </a>

                                                <h:commandLink action="#{AktuelleSchritteForm.myPlugin.renameImages(image)}" title="#{msgs.uebernehmen}" rel="tooltip" styleClass="btn btn-green font-size-s">
                                                    <i class="fa fa-floppy-o margin-right-10"></i>
                                                    <h:outputText value="#{msgs.uebernehmen}" />
                                                    <f:passThroughAttribute name="data-toggle" value="tooltip" />
                                                </h:commandLink>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!--                                     </c:forEach> -->
                            </ui:repeat>
                        </div>
                        <!-- // Thumbnail list -->

                        <div class="row">
                            <f:subview id="second">
                                <ui:include src="ImageQAPlugin_include_thumbnavigation.xhtml" />
                            </f:subview>
                        </div>

                    </h:panelGroup>
                    <h:panelGroup layout="block" rendered="#{AktuelleSchritteForm.myPlugin.sizeOfImageList gt 0}" styleClass="col-sm-5">

                        <h:panelGroup id="bigimage">

                            <div class="row pull-center">
                                <f:subview id="first_image">
                                    <ui:include src="ImageQAPlugin_include_imagenavigation.xhtml" />
                                </f:subview>
                                <ui:include src="ImageQAPlugin_include_imageControls.xhtml" />
                            </div>

                            <!-- big image -->
                            <div class="row margin-top-most margin-bottom-most">
                                <h:panelGroup styleClass="div-image" layout="block">
                                    <!--                                     <h:graphicImage class="margin-bottom-regular" value="#{AktuelleSchritteForm.myPlugin.bild}" rendered="#{AktuelleSchritteForm.myPlugin.image != null}" width="100%" /> -->
                                    <div id="mainImage" class="margin-bottom-regular" rendered="#{AktuelleSchritteForm.myPlugin.image != null}" />
                                    <div class="big-image-caption margin-top-regular font-light">
                                        <h:outputText value="#{AktuelleSchritteForm.myPlugin.image.imageName}" />
                                    </div>
                                    <script type="text/javascript">
									var configViewer = {
									    global: {
									    	divId: 'mainImage',
									        useTiles: false,
									        footerHeight: 0,
									        adaptContainerHeight: true,
									        zoomSlider: "#zoomSlider"
									    },
									    image: {
									        mimeType: "image/jpeg",
 									        tileSource : #{AktuelleSchritteForm.myPlugin.image},
									    }
									};									
									    viewImage.init( configViewer )
									    .then(function(osViewer) {
									    	console.info( 'viewer opened' );
									        //TODO: Hide loader?
									    })
									    .catch(function(error){
									        console.error( 'Error opening image', error );
									        $('#' + configViewer.global.divId).html( 'Failed to load image: "' + error + '"' );
									    });
                                    </script>
                                </h:panelGroup>
                            </div>
                            <!-- // big image -->

                            <div class="row">
                                <f:subview id="second_image">
                                    <ui:include src="ImageQAPlugin_include_imagenavigation.xhtml" />
                                </f:subview>
                            </div>

                        </h:panelGroup>
                    </h:panelGroup>

                    <h:panelGroup layout="block" rendered="#{AktuelleSchritteForm.myPlugin.sizeOfImageList == 0}" styleClass="col-sm-12">
                        <h:outputText value="#{msgs.noImagesFound}" />
                    </h:panelGroup>
                </div>

                <div class="form-actions">

                    <!-- Save -->
                    <h:commandLink styleClass="btn btn-lightgrey pull-right font-size-s" id="absenden" action="#{AktuelleSchritteForm.myPlugin.cancel}">
                        <i class="fa fa-check margin-right-5"></i>
                        <h:outputText value="#{msgs.pluginLeave}" />
                    </h:commandLink>

                </div>

            </div>

        </h:form>


        <script type="text/javascript">

	window.onload = function() {
    	loadImages();
    }
	
   function loadThumbnails() {
//		 var height = parseInt('#{Metadaten.thumbnailSize}');
		var height = parseInt('#{AktuelleSchritteForm.myPlugin.thumbnailSize}');
		if (height) {
			console.log("h√∂he ist da mit " +  height);
     		$('.goobi-thumbnail-image').css('height', (height + 25) + 'px');
    		$('.goobi-thumbnail-image .thumb').css('max-height', height + 'px');
    		$('.goobi-thumbnail-image .thumb canvas').css('max-height', height + 'px');
    		$('.goobi-thumbnail-image').css('max-width', (height) + 'px');
		}
	}
$( document ).ready(function() {
	 loadThumbnails();
});

jsf.ajax.addOnEvent(function(data) {
    var ajaxstatus = data.status; // Can be "begin", "complete" and "success"
      
      switch (ajaxstatus) {
          case "success": // This is called when ajax response is successfully processed.
              loadImages();
              loadThumbnails();
              break;
      }
	
});

function copyValue(element, e) {
    console.log(element.id);
    if (element.id =='qaform:first:txtMoveTo2') {
        document.getElementById('qaform:second:txtMoveTo2').value = element.value;
    } else if (element.id =='qaform:second:txtMoveTo2'){
        document.getElementById('qaform:first:txtMoveTo2').value = element.value;
    } else if (element.id =='qaform:first_image:txtImageMoveTo2') {
        document.getElementById('qaform:second_image:txtImageMoveTo2').value = element.value;
    } else {
        document.getElementById('qaform:first_image:txtImageMoveTo2').value = element.value;
    }
    
    var keycode;
	if (window.event)
		keycode = window.event.keyCode;
	else if (e)
		keycode = e.which;
	else
		return true;
	
	if (keycode == 13) {
		document.getElementById(element.id).nextSibling.click();
		return false;
	} else
		return true;
    
}

</script>
    </ui:define>

</ui:composition>